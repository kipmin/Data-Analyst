---
title: "ppdai_data_analyst"
author: "Kipmin"
date: "2019年3月13日"
output: html_document
---
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# 加载你最终使用的所有组件
# 在这个代码块的分析中。

# 注意，在这个代码块中，将参数 "echo" 设为假。
# This prevents the code from displaying in the knitted HTML output.这可以避免代码混入 HTML 输出显示。
# 应当在文件中，对所有代码块设为 echo=FALSE 。
Sys.setlocale('LC_ALL','Chinese')
library(dplyr)
library(ggplot2)
library(tidyr)
library(GGally)
library(readr)
library(memisc)
```

将RStudio语言设置为中文，导入本文需要的库
```{r echo=FALSE, Load_the_Data}
# 加载数据
options(scipen=200)
LC <- read_csv("LC.csv", 
    col_types = cols(`借款成功日期` = col_date(format = "%Y/%m/%d"), 
        `借款期限` = col_factor(levels = c()),
        `借款类型` = col_factor(levels = c()), 
        `初始评级` = col_factor(levels = c("A", 
            "B", "C", "D", "E", "F")), `历史成功借款次数` = col_integer(), 
        `历史正常还款期数` = col_integer(), 
        `历史逾期还款期数` = col_integer(), 
        `是否首标` = col_factor(levels = c()),
        `学历认证` = col_factor(levels = c()), 
        `征信认证` = col_factor(levels = c()), 
        `性别` = col_factor(levels = c()), 
        `户口认证` = col_factor(levels = c()), 
        `手机认证` = col_factor(levels = c()), 
        `淘宝认证` = col_factor(levels = c()), 
        `视频认证` = col_factor(levels = c())), 
    locale = locale(encoding = "GB2312"),  na = "NULL")
# LCIS <- read_csv("LCIS.csv", 
#     locale = locale(encoding = "GB2312"), na = "NULL")
# LP <- read_csv("~/School/Data-Analyst/ppdai/LP.csv", 
#     col_types = cols(recorddate = col_character(),  
#        `期数` = col_integer()), 
#    locale = locale(encoding = "GB2312"),  na = "NULL")
```

在导入数据时，将所有类别更正，把各类认证都改为分类变量，是否首标，性别，初始评级，借款期限也都是分类变量，借款日期是日期变量。在导入时无法正常显示中文，把编码改为*GB2312*，空值是NULL字符串，标注出来用na（R的空值）代替。

```{r echo=FALSE}
dim(LC)
```

```{r echo=FALSE}
str(LC)
```

```{r echo=FALSE}
summary(LC)
```
可以看出通过手机认证的最多，其次学历……最少的淘宝认证。历史成功借款次数，历史成功借款金额，总待还本金，历史正常还款期数，历史逾期还款期数，借款金额等看上去都有异常值出现。

# 整理数据

```{r echo=FALSE, warning=FALSE}
LC$credit_score <- 0
LC$credit_score <- with(LC, ifelse(`手机认证` == "成功认证", credit_score + 2, credit_score))
LC$credit_score <- with(LC, ifelse(`学历认证` == "成功认证", credit_score + 5, credit_score))
LC$credit_score <- with(LC, ifelse(`视频认证` == "成功认证", credit_score + 7, credit_score))
LC$credit_score <- with(LC, ifelse(`户口认证` == "成功认证", credit_score + 8, credit_score))
LC$credit_score <- with(LC, ifelse(`征信认证` == "成功认证", credit_score + 9, credit_score))
LC$credit_score <- with(LC, ifelse(`淘宝认证` == "成功认证", credit_score + 12, credit_score))
# 这一步在后面用作一个分类变量
LC$credit_score.bucket <- cut(LC$credit_score, c(0, 7, 15, 25, 44), right = F)
```

通过认证的方式， 根据认证难易程度，赋给每种认证不同的权重，我的想法是，**通过越多认证的人，相比于通过少的人借贷会更有优势。**
**我认为手机认证是最容易通过的认证，淘宝认证是最难通过的认证，难易程度的考究是通过各个认证通过的百分比体现的。**

```{r echo=FALSE, warning=FALSE}
create_plot <- function(varname, binwidth = 1) {
  return(ggplot(aes_string(x = varname), data = LC) + geom_histogram(binwidth = binwidth))
}
```

# 单变量绘图选择

```{r echo=FALSE, Univariate_Plots}
# 借款人的年龄分布
create_plot(LC$`年龄`) +
  xlab("年龄") + ylab("个数") +
  ggtitle("借款人的年龄分布")
```

```{r echo=FALSE}
# 借款人借的金额分布
create_plot(LC$`借款金额`, 500) +
  xlab("借款金额（元）") +
  ggtitle("借款人借的金额分布")
```

金额分布左偏，应用xlog转换。

```{r echo=FALSE}
# 借款人借的金额分布
create_plot(LC$`借款金额`, binwidth = 0.05) +
  scale_x_log10() +
  xlab("借款金额（元）") + ylab("个数") +
  ggtitle("借款人借的金额分布")
```

可以看到大多数人借的钱都在万元以内。

```{r echo=FALSE}
# 借款人的历史成功借款次数分布
ggplot(aes(`历史成功借款次数`), data = LC) +
  geom_bar() +
  ggtitle("借款人的历史成功借款次数分布")
```

该数据分布左偏，是由于极少数异常数据借款次数过多，可以去掉该部分数据

```{r echo=FALSE}
# 借款人的历史成功借款次数分布
ggplot(aes(`历史成功借款次数`), data = LC) +
  geom_bar() +
  xlim(1, quantile(LC$`历史成功借款次数`, 0.999)) +
  ggtitle("借款人的历史成功借款次数分布")
```

历史成功借款次数的人数也是次数越多，人数越少。

```{r echo=FALSE}
# 借款人的历史逾期还款期数分布
ggplot(aes(`历史逾期还款期数`), data = LC) +
  geom_bar() +
  ggtitle("借款人的历史逾期还款期数分布")
```

去掉0逾期的人数，与后面的长尾异常数据

```{r echo=FALSE}
# 借款人的历史逾期还款期数分布
ggplot(aes(`历史逾期还款期数`), data = LC) +
  geom_bar() +
  xlim(1, quantile(LC$`历史逾期还款期数`, 0.999)) +
  ggtitle("借款人的历史逾期还款期数分布")
```

```{r echo=FALSE}
ggplot(aes(x = credit_score), data = LC, binwidth = 1) +
  geom_bar() +
  xlab("信用分") + ylab("个数") +
  ggtitle("借款人的信用分分布")
```

可以看到有10万人都没有通过任何一项认证，通过认证越多的用户越少，是符合正常规律的。  

```{r echo=FALSE}
ggplot(aes(x = `借款类型`), data = LC) +
  geom_bar() +
  ylab("个数") +
  ggtitle("各借款类型使用人数")
```

电商渠道要远远低于其他3个渠道的人数。

# 单变量分析

### 你的数据集结构是什么？

包括一个主键（listingid）、7个标的特征和13个成交当时的借款人信息

|ListingId|	列表序号，为列表的唯一键。|
| --------- | -------------------------- |
|借款金额|	列表成交总金额。|
|借款期限|	总的期数（按月计）。|
|借款利率|	年化利率（百分数）。|
|借款成功日期|	列表成交的日期。都在2015年1月1日以后。|
|初始评级|	列表成交时的信用评级。AAA为安全标，AA为赔标，A-F为信用等级。|
|借款类型|	分为'应收安全标'，‘电商’，‘APP闪电’，‘普通’和‘其他’。|
|是否首标|	该标是否为借款人首标。|
|年龄|	借款人在该列表借款成功时的年龄。|
|性别|	该列表借款人性别。|
|手机认证|	该列表借款人手机实名认证是否成功。|
|户口认证|	该列表借款人户口认证是否成功。|
|视频认证|	该列表借款人视频认证是否成功。|
|学历认证|	该列表借款人学历认证是否成功。成功则表示有大专及以上学历。|
|征信认证|	该列表借款人征信认证是否成功。成功则表示有人行征信报告。|
|淘宝认证|	该列表借款人淘宝认证是否成功。成功则表示为淘宝店主。|
|历史成功借款次数|	借款人在该列表成交之前的借款成功次数。|
|历史成功借款金额|	借款人在该列表成交之前的借款成功金额。|
|总待还本金|	借款人在该列表成交之前待还本金金额。|
|历史正常还款期数|	借款人在该列表成交之前的按期还款期数。|
|历史逾期还款期数|	借款人在该列表成交之前的逾期还款期数。|
|credit_score|  通过各项维度认证综合而来的分数|

### 你的数据集内感兴趣的主要特性有哪些？

历史逾期还款期数，借款金额，借款类型，信用分，年龄，历史成功借款次数
如何通过这些特征更好地筛选借款人，降低逾期还款率，减少坏账

### 你认为数据集内哪些其他特征可以帮助你探索兴趣特点？

6个认证特征可以帮助我更加精确的确认借款人的信用如何

### 根据数据集内已有变量，你是否创建了任何新变量？

通过6个认证的难度各不相同，**按认证的难度不同，给认证模式不同的权重**，再加起来得到一个新的信用分数(credit_score)变量

### 在已经探究的特性中，是否存在任何异常分布？你是否对数据进行一些操作，如清洁、调整或改变数据的形式？如果是，你为什么会这样做？

在借款利率和借款金额上，人数分布差异太大，借款金额上，金额差距过大，credit_score的人数分布上差异太大，对差异过大的变量取了对数，使图像看上去更加清晰。暂时没有发现异常分布


# 双变量绘图选择
```{r echo=FALSE, Bivariate_Plots}
# 借款类型和借款金额的箱线图
ggplot(aes(x = `借款类型`, y = `借款金额`), data = LC) +
  geom_boxplot() +
  ylab("借款金额（元）") +
  ggtitle("借款类型和借款金额的箱线图")
```

除了电商渠道外，其他三个的box几乎看不见，用summary方法查看下其余三个的中位数等。

```{r echo=FALSE}
by(LC$`借款金额`, LC$`借款类型`, summary)
```

电商渠道最低只能借3000元，比其他三个要多很多，说明拍拍贷认为电商渠道借钱的人都有很高的偿还能力。

```{r echo=FALSE}
# 借款类型和信用分的箱线图
ggplot(aes(x = `借款类型`, y = credit_score), data = LC) +
  geom_boxplot() +
  ylab("信用分") +
  ggtitle("借款类型和信用分的箱线图")
```

对电商渠道的用户要求的认证也很高，也证明了上方电商渠道能借到更多钱的一个原因。
对app闪电的用户要求是最低的，一半以上的人都是0认证。

```{r echo=FALSE}
# 借款利率和信用分分布的箱线图
ggplot(aes(x = credit_score.bucket, y = `借款利率`), data = LC) +
  geom_boxplot() +
  xlab("信用分分布") +
  ggtitle("借款利率和信用分分布的箱线图")
```

可以看出来，中位数最高的是没有任何认证的用户，也就是没有任何认证的用户借款利率越高，而信用分越高的用户借款利率越低。

```{r echo=FALSE}
# 借款金额和信用分分布的箱线图
ggplot(aes(x = credit_score.bucket, y = `借款金额`), data = LC) +
  geom_boxplot() +
  xlab("信用分分布") +
  ylab("借款金额（元）") +
  ggtitle("借款金额和信用分分布的箱线图")
```

通过信用分最高的一部分用户分布来看，信用分越高的用户似乎能借到更多的钱，用summary方法查看详细的值。

```{r echo=FALSE}
by(LC$`借款金额`, LC$credit_score.bucket, summary)
```

通过平均数可以看出，信用分越高的用户借到的钱的确更多。

```{r echo=FALSE}
# 年龄和信用分分布的箱线图
ggplot(aes(x = credit_score.bucket, y = `年龄`), data = LC) +
  geom_boxplot() +
  xlab("信用分分布") +
  ggtitle("年龄和信用分分布的箱线图")
```

信用分越高的人有更高的年龄，绝大多数人处在20-35这个年龄区间。7-15这个区间年龄偏低，应该有很多大学生群体拉低了整体。 

```{r echo=FALSE}
# 借款金额和历史成功借款金额的散点图
ggplot(aes(x = `历史逾期还款期数`, y = `借款金额`), data = LC) +
  geom_point() +
  ylab("借款金额（元）") +
  xlim(0, quantile(LC$`历史逾期还款期数`, 0.99)) +
  ggtitle("借款金额和历史逾期还款期数的散点图")
```

通过此图可以看到，逾期多的人借款金额高的人有变少，不排除逾期期数少的情况。

```{r echo=FALSE}
# 借款金额和历史成功借款金额的散点图
ggplot(aes(x = `借款金额`, y = `历史成功借款金额`), data = LC) +
  geom_point() +
  xlab("借款金额（元）") +
  geom_smooth(method = 'lm') +
  ggtitle("借款金额和历史成功借款金额的散点图")
```

左上角有一个异常值，除去它后再重新绘图

```{r echo=FALSE}
# 借款金额和历史成功借款金额的散点图
ggplot(aes(x = `借款金额`, y = `历史成功借款金额`),
       data = subset(LC, `历史成功借款金额` < 6000000 & `历史成功借款金额` > 0)) +
  geom_point() +
  xlab("借款金额（元）") +
  geom_smooth(method = 'lm') +
  ggtitle("借款金额和历史成功借款金额的散点图")
```

```{r echo=FALSE}
with(subset(LC, `历史成功借款金额` < 6000000 & `历史成功借款金额` > 0), cor.test(`借款金额`, `历史成功借款金额`))
```

历史成功借款金额和借款金额相关性达到了0.67，证明拍拍贷会把历史成功借款金额看作一个重要的指标。

```{r echo=FALSE}
# 借款利率和借款金额关系的散点图
ggplot(aes(x = `借款利率`, y = `借款金额`), data = LC) +
  geom_point(position = position_jitter(height = 0, width = 0.3)) +
  geom_smooth(method = "lm") +
  xlab("借款利率（%）") + ylab("借款金额（元）") +
  ggtitle("借款利率和借款金额关系的散点图")
```

```{r echo=FALSE}
cor.test(LC$`借款利率`, LC$`借款金额`)
```

借款金额大多都低于5万，借款金额很多的利率大多都分布在15%左右，没有相关性。

# 双变量分析

### 探讨你在这部分探究中观察到的一些关系。这些感兴趣的特性与数据集内其他特性有什么区别？

借电商渠道的人数很少，与其他渠道相比是借款金额很高，信用分也很高。

### 你是否观察到主要特性与其他特性之间的有趣关系？

在我的观察中，我新建的变量信用分（credit_score）与其他借款相关的变量几乎都有相关性。

### 你发现最强的关系是什么？

是借款金额和历史成功借款金额的关系，除去不相关的和异常值，相关性达到了0.67

### 异常现象

0认证的人能借到的钱出乎我的意料，为何拍拍贷会把钱借给这些任何身份都没有认证的人？


# 多变量绘图选择

```{r echo=FALSE, Multivariate_Plots}
ggplot(aes(x = `借款利率`, y = `借款金额`, color = LC$`借款类型`), data = LC) +
  geom_point() +
  ylab("借款金额（元）") +
  scale_color_brewer(type = "div", guide = guide_legend(title = '借款类型')) +
  ggtitle("借款利率和借款金额的关系（借款类型）")
```

此公司在不同的借款类型给的借款利率是不同的，电商类型贡献了最多的高额中等利率贷款，其他类型的大多数借款有更低的利率，而普通和app闪电都是高息低额贷款。

```{r echo=FALSE}
ggplot(aes(x = `借款利率`, y = `借款金额`, color = credit_score.bucket),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point() +
  ylab("借款金额（元）") +
  scale_color_brewer(type = "div", guide = guide_legend(title = '信用分')) +
  ggtitle("借款利率和借款金额的关系（信用分）")
```

认证的越多，即信用分越高的人，相比于信用分低的人，有更大的概率借到利率在13-16的贷款，信用分低的人更多的处在16-24利率之间，也可以印证信用分高的都是电商类型用户。

```{r echo=FALSE}
ggplot(aes(x = `历史逾期还款期数`, y = `借款金额`, color = `借款类型`),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point() +
  ylab("借款金额（元）") +
  scale_color_brewer(type = "seq", palette = "Reds",
                     guide = guide_legend(title = '借款类型')) +
  ggtitle("历史逾期还款期数与借款金额的关系（借款类型）")
```

有少数异常数据，筛选掉异常数据。

```{r echo=FALSE}
ggplot(aes(x = `历史逾期还款期数`, y = `借款金额`, color = `借款类型`),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point() +
  ylab("借款金额（元）") +
  coord_cartesian(xlim = c(0, quantile(LC$`历史逾期还款期数`, 0.99)),
                  ylim = c(0, quantile(LC$`借款金额`, 0.99))) +
  scale_color_brewer(type = "seq", palette = "Reds",
                     guide = guide_legend(title = '借款类型')) +
  ggtitle("历史逾期还款期数与借款金额的关系（借款类型）")
```

APP闪电渠道都是低额贷款，逾期相对于别的类型似乎很高。另外3种借款类型几乎都是高额贷款

```{r echo=FALSE}
ggplot(aes(x = `历史成功借款次数`, y = `历史逾期还款期数`, color = `credit_score.bucket`),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point(position = position_jitter(height = 0)) +
  coord_cartesian(xlim = c(0, quantile(LC$`历史成功借款次数`, 0.99))) +
  scale_color_brewer(type = "div", guide = guide_legend(title = '信用分')) +
  ggtitle("历史成功借款次数和历史逾期还款期数的关系（信用分）")
```

高信用分的人有更高的借贷次数，在借贷次数中高信用分的占比也增大了，但是高信用分的人相对于低信用分的人有更高的违约次数。

```{r echo=FALSE}
# 借款利率和借款金额关系的散点图
ggplot(aes(x = `借款利率`, y = `借款金额`, color = credit_score), data = LC) +
  geom_point(position = position_jitter(height = 0, width = 0.3)) +
  ylab("借款金额（元）") +
  xlab("借款利率（%）") +
  ggtitle("借款利率和借款金额关系的散点图")
```

# 多变量分析

###  探讨你在这部分探究中观察到的一些关系。通过观察感兴趣的特性，是否存在相互促进的特性？

历史逾期还款期数越高的人，有着更高的信用分，即，认证了更多项，在探索中，逾期次数过高的人的确借贷的次数变少了，借贷金额也相对变低。


### 这些特性之间是否存在有趣或惊人的联系呢？

借款类型是最影响借款利率和借款金额的分类，相比之下，信用分会影响借款的金额和利率，历史成功借款金额和历史逾期还款期数也对借款金额有很大相关性。

### 选项：你是否创建过数据集的任何模型？讨论你模型的优缺点。

```{r echo=FALSE}
p1 <- lm(I(`借款金额`)~ `手机认证` + `学历认证` + `视频认证` + 
                        `户口认证` + `征信认证` + `淘宝认证`, data = subset(LC, `借款类型` != "其他"))
p2 <- update(p1, ~. + I(`历史成功借款金额`))
p3 <- update(p2, ~. + `借款类型`)
p4 <- update(p3, ~. + `历史正常还款期数`)
p5 <- update(p4, ~. + `历史成功借款次数`)
mtable(p3, p4, p5)
```

创建了一个关于借贷金额的模型

优点：我判断其他类型的借贷是由专人去寻找贷款人的，所以不计入模型,提高了模型的精度。

缺点：我创建的模型相关性只达到了0.5。。

------

# 定稿图与总结

### 绘图一
```{r echo=FALSE, Plot_One}
ggplot(aes(x = `历史逾期还款期数`, y = `借款金额`, color = `借款类型`),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.4, height = 0)) +
  ylab("借款金额（元）") +
  coord_cartesian(xlim = c(0, quantile(LC$`历史逾期还款期数`, 0.99)),
                  ylim = c(0, quantile(LC$`借款金额`, 0.99))) +
  scale_color_brewer(type = "seq", palette = "Reds",
                     guide = guide_legend(title = '借款类型')) +
  ggtitle("历史逾期还款期数与借款金额的关系（借款类型）")
```

###描述一

可以看出拍拍贷公司在自己的app中借贷额度普遍不高，逾期还款率较其他类型来说也少很多，逾期还款期数越高的人，借贷的人数也越来越低。

### 绘图二
```{r echo=FALSE, Plot_Two}
# 借款利率和借款金额关系的散点图
ggplot(aes(x = `借款利率`, y = `借款金额`, color = credit_score.bucket), data = subset(LC, `借款类型` != "其他")) +
  geom_point(position = position_jitter(height = 0, width = 0.3)) +
  scale_y_log10() +
  xlab("借款利率（%）") + ylab("借款金额（元）") +
  scale_color_brewer(type = "seq", palette = "Oranges") +
  ggtitle("借款利率和借款金额关系的散点图")

```

### 描述二

信用分高的人都处在中间利率，借款金额高的区域，低信用分的用户都在图中右下角区域，图中除去了其他类型的数据，这部分是人为判断的，所以从信用分无法体现出来。

### 绘图三
```{r echo=FALSE, Plot_Three}
ggplot(aes(x = `历史成功借款次数`, y = `借款金额`, color = credit_score.bucket),
       data = subset(LC, !is.na(credit_score.bucket))) +
  geom_point(alpha = 1/5, position = position_jitter(width = 0.4, height = 0)) +
  ylab("借款金额（元）") +
  coord_cartesian(xlim = c(0, quantile(LC$`历史成功借款次数`, 0.99)), 
                  ylim = c(0, quantile(LC$`借款金额`, 0.99))) +
  scale_color_brewer(type = "seq", palette = "Reds",
                     guide = guide_legend(title = '信用分')) +
  ggtitle("借款金额与历史成功借款次数的关系（信用分）")
```

### 描述三

大多数信用分高的人都有更高的借款金额和更多的借款次数，拍拍贷对信用高的用户更加信任，同时，成功借款次数更多的用户中，借款金额高的用户占比也在提高。

------

# 反思


拍拍贷的数据分析项目包含了15年到16年的部分业务数据，那时也是P2P金融最火的一段时间，由于数据量过大，我只集中精力研究了LC表，我先了解了LC表中的各个变量，再从我感兴趣的方面下手，**作为一个借贷公司，没有银行的背书，如何把钱借给能还钱的人？**，我先对借贷的人群进行了初步了解，然后假设了一个信用分的模型，从此下手探索我的模型与借款人行为的关系，发现借贷行为与信用分都产生了相关性。在更深入的了解借贷行为时，发现人们的行为与我的想象有很大出入，我认为人们会更非常在乎自己的信用是否良好，但仅仅是借贷公司而不是国家银行的话，人们似乎都不在意是否逾期与拖欠，我便开始了解拍拍贷公司如何解决这一问题，它的做法是，大额低息借贷都是经过借贷人员考察的借贷人，人为检查借贷人的资产偿还能力，这是**借贷类型中的其他**。电商渠道可以借高额贷款是因为与某些电商合作，借贷人的违约成本较高，而且利率不低，平衡好风险的情况下是可以做的，而自己的软件只做一些给大学生提供的小额贷款，利率高，而且大学生相对来说违约的情况更少。但是通过后面的分析发现逾期的情况还是很多，如何进一步缩小逾期的可能？我猜测借贷人的历史行为也会成为拍拍贷衡量是否放贷的标准之一，分析后也验证了我的猜测。









